---
title: "Prediction of toddler vocabulary from infant speech and non-speech processing"
author: "Alejandrina Cristia"
date: "Main version 2020-07-30"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Hmisc) #for cor mat
library(brms)
library(bayestestR)

#functions
zscore<-function(x) (x - mean(x,na.rm=T))/ sd(x,na.rm=T)

fit_uni_print <- function(mymodel, thisvar) {
  print(thisvar)
  print(plot(mymodel))
  pp_check(mymodel, nsamples = 1000)
  print(mymodel)
  saveRDS(summary(mymodel), file = paste(thisvar, "main_model_summary.rds",sep="_"))
  in_bf = bayesfactor_parameters(mymodel, null = 0)
  print(in_bf)
  print(plot(in_bf))
  saveRDS(in_bf, file = paste(thisvar, "main_model_bf.rds",sep="_"))
}

cohensd<-function(pref_vector) mean(pref_vector-.5, na.rm=T)/sd(pref_vector, na.rm=T)


# IMPORTANT: SET THIS TO TRUE IF YOU WANT TO RECALCULATE ALL THE MODELS
RECALC=FALSE
```

## History

- 2020-07-30: First version
- 2020-07-31: Final version of analyses
- 2020-08-04: Making sure that everything is in the same order as in the manuscript

## TODO

- add code to produce the tables:
- 1 has m(sd) & age for the 7 measures, cohen's d, and estimate (SE), where possible
- 2 is the cor mat
- 3 has m (SD, N) for hit, error, fail for the 6 measures, F, p --> probably do m (SD) then F df p
- 4 now is estimate for var, estimate for var*age
- 5
- create OSF
- upload stuff
- add here the code for the regression
- add explanations

## Read and preprocess data

```{r startup, echo=FALSE}


read.csv("Longitudinal_8_22_16.csv")->mydat # read in the data

#check that everything looks OK
names(mydat)
dim(mydat)
summary(mydat)


#clean up
mydat$Subject.. <- factor(mydat$Subject..)
mydat$ A.not.B.score  <- factor(mydat$ A.not.B.score )
mydat[!is.na(mydat$Subject..), ] -> data #97 observations
mydat[, -29] -> mydat


##there is an outlier in age CDI 24, it has been checked, it is his/her real CDI age 
#after discussion, we decide to remove the data from  this outlier child from the 24m analysis
mydat[mydat$X24mCDIAge>26 & !is.na(mydat$X24mCDIAge), c("X24mCDIAge","X24mCom","X24msay" , "X24mSayALL","X24mSayGenderSpec")] <- NA

# z-scored
mydat$com18z=zscore(mydat$X18mCom)
mydat$say18z=zscore(mydat$X18mSay)
mydat$say24z=zscore(mydat$X24msay)

mydat$anotB=NA
mydat$anotB[mydat$A.not.B.score==1]<-"fail"
mydat$anotB[mydat$A.not.B.score==2]<-"error"
mydat$anotB[mydat$A.not.B.score==3]<-"pass"


# Create stacked version of the data

stdatz=cbind( mydat[,c("Subject..","Gender","Vowel.Alt.pref.quotient","A.not.B.score","vowels.Age", "total.tro.pref.quotient","Novelty.VRM","VRM.age")], stack(mydat[,c("com18z","say18z","say24z")]))

#note that the age for vowel and a not b is (mostly) the same, the age for stress & vrm is the same
summary(stdatz)


```

## Beginning of results section

Analyses were implemented in the R environment (R Core Team, 2014), and are available from supplementary materials.  Table 1 presents the summary statistics for each measure.

### Table 1

```{r tab1}


doline<-function(myage,myvec,prettyname,dod=F){
  #myage=mydat$vowels.Age
  #myvec=mydat$Vowel.Alt.pref.quotient
  #prettyname="Vowel"
  #dod=T
  cbind(prettyname,sum(!is.na(myvec)),
        paste0(round(mean(myage,na.rm=T),2)," (",round(sd(myage,na.rm=T),2),")"), #age(sd)
        paste0(round(mean(myvec,na.rm=T),2)," (",round(sd(myvec,na.rm=T),2),")"), #score(sd)
        ifelse(dod,round(cohensd(myvec),3),"")
        )
}


tab1=rbind(
  doline(mydat$VRM.age,mydat$total.tro.pref.quotient,"Stress",T),
  doline(mydat$VRM.age,mydat$Novelty.VRM,"VRM",T),
  doline(mydat$vowels.Age,mydat$Vowel.Alt.pref.quotient,"Vowel",T),
  doline(mydat$A.not.B.Age,as.numeric(mydat$A.not.B.score),"A-not-B",F),
  doline(mydat$X18mCDIAge,mydat$X18mCom,"18m receptive",F),
  doline(mydat$X18mCDIAge,mydat$X18mSay,"18m expressive",F),
  doline(mydat$X24mCDIAge,mydat$X24msay,"24m expressive",F)
  )

colnames(tab1)<-c("Measure",	"No.",	"Age (SD)",	"Score (SD)",	"Cohen's d")
write.table(tab1,file="tab1.txt",row.names=F,quote=F,sep="\t")

```


### Distribution checks

Prior to any analysis, we inspected the distributions of each measure using histograms and QQ plots. The distribution of the 3 continuous infant measures, namely, Stress, Vowel, and VRM, were approximately normal. However, the 3 vocabulary measures were not normally distributed. Therefore, we standardized the three outcome measures by applying z-scoring and then trimmed values more than 3 SD (N = 1) to improve the residual distribution, which yielded an approximately normal distribution of the outcome measures. 
 
```{r checkuni,echo=T}

table(data$A.not.B.score)

#outcomes
for(thisvar in predictors) hist(data[,thisvar],main=thisvar)

#outcomes - separated
for(thisvar in outcomes) hist(data[,thisvar],main=thisvar)

#outcomes - combined - percentiles
hist(stdat$values[stdat$ind %in% c('X18mComGenderSpec', 'X18mSayGenderSpec', 'X24mSayGenderSpec')],main="Combined-percentiles")

#outcomes - combined - raw
hist(stdat$values[!(stdat$ind %in% c('X18mComGenderSpec', 'X18mSayGenderSpec', 'X24mSayGenderSpec'))],main="Combined-raw")

#outcomes - combined - raw+Z
hist(stdatz$values,main="Combined-raw+Z")


# find outliers for each variable
for(thisvar in c(outcomes,predictors)) {
  #create a z-score for the observations
  z = (data[,thisvar] - mean(data[,thisvar], na.rm=T) )/ sd(data[,thisvar], na.rm=T)
  print(paste("there are",sum(abs(z)> 3, na.rm=T),"observations that are outliers 
          at 3 SD in", thisvar))
} 

table(abs(stdatz$values)>3)
```
 
## Bivariate relationship among predictors     

### Correlation matrix
Table 2 presents the bivariate correlations between infant measures that were continuous (Stress, Vowel, VRM), and language outcome measures (18m receptive, 18m expressive, and 24m expressive vocabulary).

```{r cors}
cor.mat=rcorr(as.matrix(mydat[,c("total.tro.pref.quotient","Vowel.Alt.pref.quotient", "Novelty.VRM",
            "com18z","say18z","say24z")]))

# r values
cor.mat$r

# p values
cor.mat$P

# Ns
cor.mat$n

write.table(cor.mat$r,file="cormat.txt")
write.table(cor.mat$P,file="cormat.txt",append=T)
write.table(cor.mat$n,file="cormat.txt",append=T)
```


## Regressions for AnotB
Given that the A-not-B measure was categorical, we performed 6 separate one-way analyses of variance (ANOVAs) to examine whether there were differences on the other tasks with continuous data as a function of A-not-B outcome.

```{r anotb}
regtab=NULL

for(thisvar in c("total.tro.pref.quotient","Vowel.Alt.pref.quotient", "Novelty.VRM",
            "com18z","say18z","say24z")) {
  myaov=summary(aov(mydat[,thisvar]~anotB,data=mydat))
  regtab=rbind(regtab,
               cbind(thisvar, unlist(myaov)["Df2"], unlist(myaov)["F value1"], unlist(myaov)["Pr(>F)1"]))}


regtab
write.table(regtab,file="regtab.txt")
```


## Setting up models

If RECALC is TRUE then the next chunk will not be done...
```{r readrds, eval=!RECALC}

readRDS("vowel main_model.rds")->vowel
readRDS("anotb main_model.rds")->anb
readRDS("stress main_model.rds")->strs
readRDS("vrm main_model.rds")->vrm
readRDS("main_model.rds")->main
```

... but this one will:

```{r setprior, eval=RECALC}
niter=4000
nwarmup=500

#values for scaled variables -- this cannot be passed as a variable to stan, but it's noted here for clarity
nu=3
s=1

our_priors <- c(prior("student_t(3,0,1)", class = b),
              prior("student_t(3,0,1)", class = Intercept)
             )
```

## Prediction of vocabulary from each infant measure     

### Univariate Bayesian models

#### Vowels

```{r vow, eval=RECALC}

vowel = brm(values ~ 
   Vowel.Alt.pref.quotient*vowels.Age +
  + ind + (1 | Subject..), data=stdatz,
  prior = our_priors,
             iter=niter, warmup=nwarmup, chains=4,cores=2,
             seed=12,
             save_all_pars = T,
             sample_prior = T
  )
saveRDS(vowel, file = paste("vowel", "main_model.rds",sep="_"))

```

```{r}
fit_uni_print(vowel,"vowel")
```


#### A-not-B

```{r anb, eval=RECALC}

anb = brm(values ~ 
   A.not.B.score*vowels.Age +
  + ind + (1 | Subject..), data=stdatz,
  prior = our_priors,
             iter=niter, warmup=nwarmup, chains=4,cores=2,
             seed=12,
             save_all_pars = T,
             sample_prior = T
  )

saveRDS(anb, file = paste("anotb", "main_model.rds",sep="_"))

```

```{r}
fit_uni_print(anb,"anotb")
```


#### Stress

```{r strs, eval=RECALC}

strs = brm(values ~ 
   total.tro.pref.quotient*VRM.age +
  + ind + (1 | Subject..), data=stdatz,
  prior = our_priors,
             iter=niter, warmup=nwarmup, chains=4,cores=2,
             seed=12,
             save_all_pars = T,
             sample_prior = T
  )

saveRDS(strs, file = paste("stress", "main_model.rds",sep="_"))

```

```{r}
fit_uni_print(strs,"stress")
```

#### VRM

```{r vrm, eval=RECALC}

vrm = brm(values ~ 
   Novelty.VRM*VRM.age +
  + ind + (1 | Subject..), data=stdatz,
  prior = our_priors,
             iter=niter, warmup=nwarmup, chains=4,cores=2,
             seed=12,
             save_all_pars = T,
             sample_prior = T
  )

saveRDS(vrm, file = paste("vrm", "main_model.rds",sep="_"))

```

```{r}
fit_uni_print(vrm,"vrm")
```

## Evaluating the relative importance of different predictors 
### Frequentist analysis

### Multivariate Bayesian model


```{r pred_ini, eval=RECALC}



main = brm(values ~ 
   total.tro.pref.quotient + Vowel.Alt.pref.quotient + Novelty.VRM + A.not.B.score +
     Gender + ind + (1 | Subject..), data = stdatz,
  prior = our_priors,
             iter=niter, warmup=nwarmup, chains=4,cores=2,
             seed=12,
             save_all_pars = T,
             sample_prior = T
  )
saveRDS(main,file="main_model.rds")

```

```{r}

plot(main)

pp_check(main, nsamples = 1000)

main

saveRDS(summary(main),file="main_model_summary.rds")


in_bf = bayesfactor_parameters(main, null = 0)
in_bf
plot(in_bf)
saveRDS(in_bf,file="main_model_bf.rds")

```





